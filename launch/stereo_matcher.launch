<?xml version="1.0"?>
<!--XML-->
<launch>

    <!-- SETUP ARGUMENTS -->
    <arg name="gui" default="false"/>
    <arg name="camera_name" default="stereo"/>
    <arg name="camera_namespace" default="stereo"/>
    <arg name="split_laser" default="false"/>
    <arg name="suffix" default=""/>

    <arg name="stereo_algorithm" default="0" />
    <arg name="min_disparity" default="128" />
    <arg name="disparity_range" default="256" />
    <arg name="correlation_window_size" default="19" />
    <arg name="uniqueness_ratio" default="2" />
    <arg name="texture_threshold" default="10" />
    <arg name="speckle_range" default="4" />
    <arg name="speckle_size" default="1000" />
    <arg name="prefilter_size" default="147" />
    <arg name="prefilter_cap" default="7" />
    <arg name="p1" default="200"/>
    <arg name="p2" default="400"/>
    <arg name="interp" default="false"/>

    <arg name="depth_max" default="10" />

    <arg if="$(arg split_laser)" name="left_image_topic" default="left/image_raw_with_laser"/>
    <arg if="$(arg split_laser)" name="right_image_topic" default="right/image_raw_with_laser"/>
    <arg unless="$(arg split_laser)" name="left_image_topic" default="left/image_raw"/>
    <arg unless="$(arg split_laser)" name="right_image_topic" default="right/image_raw"/>

    <arg if="$(arg split_laser)" name="left_image_rect_topic" default="left/image_rect_with_laser"/>
    <arg if="$(arg split_laser)" name="right_image_rect_topic" default="right/image_rect_with_laser"/>
    <arg unless="$(arg split_laser)" name="left_image_rect_topic" default="left/image_rect"/>
    <arg unless="$(arg split_laser)" name="right_image_rect_topic" default="right/image_rect"/>

    <arg if="$(arg split_laser)" name="left_image_color_topic" default="left/image_color_with_laser"/>
    <arg if="$(arg split_laser)" name="right_image_color_topic" default="right/image_color_with_laser"/>
    <arg unless="$(arg split_laser)" name="left_image_color_topic" default="left/image_color"/>
    <arg unless="$(arg split_laser)" name="right_image_color_topic" default="right/image_color"/>

    <arg if="$(arg split_laser)" name="left_image_mono_topic" default="left/image_mono_with_laser"/>
    <arg if="$(arg split_laser)" name="right_image_mono_topic" default="right/image_mono_with_laser"/>
    <arg unless="$(arg split_laser)" name="left_image_mono_topic" default="left/image_mono"/>
    <arg unless="$(arg split_laser)" name="right_image_mono_topic" default="right/image_mono"/>

    <arg if="$(arg split_laser)" name="left_image_rect_color_topic" default="left/image_rect_color_with_laser"/>
    <arg if="$(arg split_laser)" name="right_image_rect_color_topic" default="right/image_rect_color_with_laser"/>
    <arg unless="$(arg split_laser)" name="left_image_rect_color_topic" default="left/image_rect_color"/>
    <arg unless="$(arg split_laser)" name="right_image_rect_color_topic" default="right/image_rect_color"/>

    <arg name="left_image_info_topic" default="left/camera_info"/>
    <arg name="right_image_info_topic" default="right/camera_info"/>
    <arg name="depth_optical_frame" default="$(arg camera_name)_depth_optical_frame"/>

    <arg name="jr_config_file" default="$(find i3dr_stereo_camera)/ini/JR_matchingparam_without_interpolation.cfg"/>

    <arg name="use_i3dr_matcher" default="false"/>
            <!-- Matcher Parameters -->
        <!-- see link below for details on matcher parameters -->
        <!-- http://wiki.ros.org/stereo_image_proc/Tutorials/ChoosingGoodStereoParameters -->
        <!-- algorithm 0: OpenCV block -->
        <!-- algorithm 1: OpenCV SGBM -->
        <!-- algorithm 2: JR SGB -->

        <!-- Matcher Parameters -->
        <!-- see link below for details on matcher parameters -->
        <!-- http://wiki.ros.org/stereo_image_proc/Tutorials/ChoosingGoodStereoParameters -->
        <!-- algorithm 0: OpenCV block -->
        <!-- algorithm 1: OpenCV SGBM -->
        <!-- approximate sync used when cameras are not perfectly triggered in unison -->

    <!-- STEREO <MATCHER> -->
    <node unless="$(arg use_i3dr_matcher)" ns="$(arg camera_namespace)" pkg="stereo_image_proc" type="stereo_image_proc" name="stereo_image_proc_$(arg camera_name)_$(arg suffix)" output="screen">
        
        <param name="stereo_algorithm" value="$(arg stereo_algorithm)" />
        <param name="min_disparity" value="$(arg min_disparity)" />
        <param name="disparity_range" value="$(arg disparity_range)" />
        <param name="correlation_window_size" value="$(arg correlation_window_size)" />
        <param name="uniqueness_ratio" value="$(arg uniqueness_ratio)" />
        <param name="texture_threshold" value="$(arg texture_threshold)" />
        <param name="speckle_range" value="$(arg speckle_range)" />
        <param name="speckle_size" value="$(arg speckle_size)" />
        <param name="prefilter_size" value="$(arg prefilter_size)" />
        <param name="prefilter_cap" value="$(arg prefilter_cap)" />
        <param name="p1" value="$(arg p1)" />
        <param name="p2" value="$(arg p2" />

        
        <param name="approximate_sync" value="true" />
        <param name="queue_size" value="50"/>

        <remap from="left/image_raw" to="$(arg left_image_topic)"/>
        <remap from="right/image_raw" to="$(arg right_image_topic)"/>
        <remap from="left/camera_info" to="$(arg left_image_info_topic)"/>
        <remap from="right/camera_info" to="$(arg right_image_info_topic)"/>

        <remap from="right/image_color" to="$(arg right_image_color_topic)"/>
        <remap from="right/image_mono" to="$(arg right_image_mono_topic)"/>
        <remap from="right/image_rect" to="$(arg right_image_rect_topic)"/>
        <remap from="right/image_rect_color" to="$(arg right_image_rect_color_topic)"/>

        <remap from="left/image_color" to="$(arg left_image_color_topic)"/>
        <remap from="left/image_mono" to="$(arg left_image_mono_topic)"/>
        <remap from="left/image_rect" to="$(arg left_image_rect_topic)"/>
        <remap from="left/image_rect_color" to="$(arg left_image_rect_color_topic)"/>
    </node>

    <node if="$(arg use_i3dr_matcher)" ns="$(arg camera_namespace)" pkg="i3dr_stereo_camera" type="generate_disparity" name="i3dr_disparity_$(arg camera_name)_$(arg suffix)" output="screen">


        <param name="frame_id" value="$(arg depth_optical_frame)"/>

        <param name="stereo_algorithm" value="$(arg stereo_algorithm)" />
        <param name="min_disparity" value="$(arg min_disparity)" />
        <param name="disparity_range" value="$(arg disparity_range)" />
        <param name="correlation_window_size" value="$(arg correlation_window_size)" />
        <param name="uniqueness_ratio" value="$(arg uniqueness_ratio)" />
        <param name="texture_threshold" value="$(arg texture_threshold)" />
        <param name="speckle_range" value="$(arg speckle_range)" />
        <param name="speckle_size" value="$(arg speckle_size)" />
        <param name="p1" value="$(arg p1)" />
        <param name="p2" value="$(arg p2)" />
        <param name="interp" value="$(arg interp)" />

        <param name="jr_config_file" value="$(arg jr_config_file)" />

        <remap from="left/image_raw" to="$(arg left_image_topic)"/>
        <remap from="right/image_raw" to="$(arg right_image_topic)"/>
        <remap from="left/camera_info" to="$(arg left_image_info_topic)"/>
        <remap from="right/camera_info" to="$(arg right_image_info_topic)"/>
        <remap from="left/image_rect" to="$(arg left_image_rect_topic)"/>
        <remap from="right/image_rect" to="$(arg right_image_rect_topic)"/>

        <param name="queue_size" value="10"/>
    </node>

    <!-- Convert disparity to depth -->
    <group ns="$(arg camera_namespace)">
        <node pkg="i3dr_stereo_camera" type="disparity_to_depth" name="i3dr_disparity2depth_$(arg camera_name)_$(arg suffix)" output="screen">
            <param name="depth_max" value="$(arg depth_max)" />
        </node>
    </group>

    <!-- DISPLAY -->
    <!-- display phobos disparity image -->
    <node if="$(arg gui)" pkg="image_view" type="disparity_view" name="disparity_view_$(arg camera_name)_$(arg suffix)" output="screen">
        <remap from="image" to="/$(arg camera_namespace)/disparity" />
    </node>

    <!-- run rqt control gui for adjusting stereo configuration -->
    <node pkg="rqt_reconfigure" type="rqt_reconfigure" name="display_controls_$(arg camera_name)_$(arg suffix)" />

</launch>
